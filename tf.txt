resource "kubernetes_namespace" "this" {
  metadata {
	name = var.namespace
  }
}


resource "helm_release" "prometheus" {
  chart = "prometheus"
  name = "prometheus"
  namespace = var.namespace
  repository = "https://prometheus-community.github.io/helm-charts"

  # When you want to directly specify the value of an element in a map you need \\ to escape the point.
  set {
  name = "podSecurityPolicy\\.enabled"
  value = true
  }

  set {
  name  = "serverFiles\\.alerting_rules\\.yml\\.groups"
  value = yamlencode({
    alert = ContainerMemoryUsage
    expr = {
    (sum(container_memory_working_set_bytes{name!=""}) BY (instance, name) / sum(container_spec_memory_limit_bytes > 0) BY (instance, name) * 100) > 10
    }
    for = {
    2m
    }
    labels = {
    severity: warning
    }
  })
  }

  set {
  name = "server\\.persistentVolume\\.enabled"
  value = false
  }

  set {
  name = "server\\.resources"
  # You can provide a map of value using yamlencode  
  value = yamlencode({
    limits = {
    cpu = "200m"
    memory = "50Mi"
    }
    requests = {
    cpu = "100m"
    memory = "30Mi"
    }
  })
  }
}
